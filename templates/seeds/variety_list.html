{% extends "base.html" %}
{% load static %}

{% block title %}Seed Library – Heritage Tomato Club{% endblock title %}

{% block content %}
<main class="max-w-6xl mx-auto px-4 py-10 space-y-8">
  <!-- Page heading -->
  <section class="space-y-3">
    <h1 class="text-3xl md:text-4xl font-bold">Seed Library</h1>
    <p class="text-base md:text-lg max-w-3xl">
      Browse the club’s collection of heritage and heirloom tomato varieties.
      This is an evolving list as we trial new lines and retire others.
    </p>
  </section>

  <!-- Filter controls (pills + search + sort) -->
  <section class="card bg-base-100 shadow border border-base-300/60">
    <div class="card-body space-y-4">
      <form method="get" id="filter-form" class="space-y-4">

        <!-- Search + sort row -->
        <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <!-- Search -->
          <label class="form-control w-full md:max-w-xs">
            <span class="label-text">Search by name or origin</span>
            <input
              type="text"
              name="q"
              value="{{ current_filters.q }}"
              placeholder="e.g. Brandywine, Russian, Cornwall…"
              class="input input-bordered w-full"
            />
          </label>

          <!-- Sort pills -->
          <div class="w-full md:w-auto">
            <span class="label-text block mb-1">Sort by</span>
            <div class="flex flex-wrap gap-2">
              {% for value, label in sort_choices %}
                {% if current_filters.sort == value %}
                  <button
                    type="button"
                    class="btn btn-sm rounded-full btn-primary"
                    data-filter-name="sort"
                    data-filter-value="{{ value }}"
                    aria-pressed="true"
                  >
                    {{ label }}
                  </button>
                {% else %}
                  <button
                    type="button"
                    class="btn btn-sm rounded-full btn-outline"
                    data-filter-name="sort"
                    data-filter-value="{{ value }}"
                    aria-pressed="false"
                  >
                    {{ label }}
                  </button>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>


        <!-- Clear all filters pill -->
        <div class="flex justify-end">
          <button
            type="button"
            class="btn btn-xs md:btn-sm rounded-full btn-ghost"
            data-clear-filters="true"
          >
            Clear all filters
          </button>
        </div>

        <!-- Pills groups -->
        <div class="space-y-3">
          <!-- Colour pills -->
<div>
  <span class="label-text block mb-1">Fruit colour</span>
  <div class="flex flex-wrap gap-2">
    {% for value, label in colour_choices %}
      {% if current_filters.colour == value %}
        <button
          type="button"
          class="btn btn-xs md:btn-sm rounded-full btn-primary"
          data-filter-name="colour"
          data-filter-value="{{ value }}"
          data-colour="{{ value }}"
          aria-pressed="true"
        >
          {{ label }}
        </button>
      {% else %}
        <button
          type="button"
          class="btn btn-xs md:btn-sm rounded-full btn-outline"
          data-filter-name="colour"
          data-filter-value="{{ value }}"
          data-colour="{{ value }}"
          aria-pressed="false"
        >
          {{ label }}
        </button>
      {% endif %}
    {% endfor %}
  </div>
</div>


          <!-- Growth habit pills -->
          <div>
            <span class="label-text block mb-1">Growth habit</span>
            <div class="flex flex-wrap gap-2">
              {% for value, label in habit_choices %}
                {% if current_filters.habit == value %}
                  <button
                    type="button"
                    class="btn btn-xs md:btn-sm rounded-full btn-primary"
                    data-filter-name="habit"
                    data-filter-value="{{ value }}"
                    aria-pressed="true"
                  >
                    {{ label }}
                  </button>
                {% else %}
                  <button
                    type="button"
                    class="btn btn-xs md:btn-sm rounded-full btn-outline"
                    data-filter-name="habit"
                    data-filter-value="{{ value }}"
                    aria-pressed="false"
                  >
                    {{ label }}
                  </button>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Hidden inputs that actually hold the filter values -->
        <input type="hidden" name="colour" id="filter-colour" value="{{ current_filters.colour }}">
        <input type="hidden" name="habit" id="filter-habit" value="{{ current_filters.habit }}">
        <input type="hidden" name="sort" id="filter-sort" value="{{ current_filters.sort|default:'name' }}">

        <!-- Buttons row (fallback / manual apply) -->
        <div class="flex flex-wrap gap-2 justify-end pt-1">
          <a href="{% url 'seeds:variety_list' %}" class="btn btn-ghost btn-sm">
            Clear filters
          </a>
          <button type="submit" class="btn btn-primary btn-sm">
            Apply
          </button>
        </div>
      </form>

      <!-- Active filters summary -->
      {% if current_filters.colour or current_filters.habit or current_filters.q %}
        <div class="mt-1 flex flex-wrap gap-2 text-sm items-center">
          <span class="font-semibold">Active filters:</span>
          {% if current_filters.q %}
            <span class="badge badge-outline">Search: “{{ current_filters.q }}”</span>
          {% endif %}
          {% if current_filters.colour %}
            <span class="badge badge-outline">Colour: {{ current_filters.colour|title }}</span>
          {% endif %}
          {% if current_filters.habit %}
            <span class="badge badge-outline">Habit: {{ current_filters.habit|title }}</span>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </section>

  {% if varieties %}
    <!-- Varieties grid -->
    <section class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {% for variety in varieties %}
        <article class="card bg-base-100 shadow-md border border-base-300/60">
          <!-- Image / placeholder -->
          <figure class="h-40 md:h-48 overflow-hidden border-b border-base-300/60">
            {% if variety.image %}
              <img
                src="{{ variety.image.url }}"
                alt="{{ variety.name }}"
                class="w-full h-full object-cover"
              >
            {% else %}
              <img
                src="{% static 'img/placeholder-tomato.jpg' %}"
                alt="No photo available"
                class="w-full h-full object-cover opacity-80"
              >
            {% endif %}
          </figure>

          <div class="card-body">
            <h2 class="card-title text-xl">
              <a href="{{ variety.get_absolute_url }}" class="link link-hover">
                {{ variety.name }}
              </a>
            </h2>

            {% if variety.origin %}
              <p class="text-sm opacity-80">
                Origin: {{ variety.origin }}
              </p>
            {% endif %}

            <ul class="text-sm space-y-1 mt-2">
              {% if variety.growth_habit %}
                <li>
                  <span class="font-semibold">Habit:</span>
                  {{ variety.get_growth_habit_display }}
                </li>
              {% endif %}
              {% if variety.fruit_color %}
                <li>
                  <span class="font-semibold">Fruit colour:</span>
                  {{ variety.fruit_color }}
                </li>
              {% endif %}
              {% if variety.days_to_maturity %}
                <li>
                  <span class="font-semibold">Days to maturity:</span>
                  ~{{ variety.days_to_maturity }} days
                </li>
              {% endif %}
            </ul>

            {% if variety.description %}
              <p class="mt-3 text-sm">
                {{ variety.description|truncatewords:30 }}
              </p>
            {% endif %}

            <div class="card-actions justify-end mt-4">
              <a href="{{ variety.get_absolute_url }}" class="btn btn-sm btn-primary">
                View details
              </a>
            </div>
          </div>
        </article>
      {% endfor %}
    </section>

    <!-- Pagination -->
    {% if is_paginated %}
      <div class="mt-6 flex justify-center">
        <div class="join">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-sm join-item">
              « Prev
            </a>
          {% endif %}
          <button class="btn btn-sm join-item btn-ghost">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </button>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-sm join-item">
              Next »
            </a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% else %}
    <p class="mt-6 opacity-80">
      No varieties in the Seed Library yet. Once you add some in the admin,
      they’ll appear here.
    </p>
  {% endif %}
</main>

<!-- JS: pills -> hidden inputs + auto-submit -->
<script>
  (function () {
    const form = document.getElementById("filter-form");
    if (!form) return;

    const hiddenInputs = {
      colour: document.getElementById("filter-colour"),
      habit: document.getElementById("filter-habit"),
      sort: document.getElementById("filter-sort"),
    };

    const DEFAULT_SORT = "name";

    function setHiddenValue(filterName, value) {
      const input = hiddenInputs[filterName];
      if (!input) return;
      input.value = value || "";
    }

    function clearPageParam() {
      const pageInput = form.querySelector('input[name="page"]');
      if (pageInput) {
        pageInput.remove();
      }
    }

    function autoSubmit() {
      clearPageParam();
      if (form.requestSubmit) {
        form.requestSubmit();
      } else {
        form.submit();
      }
    }

    form.addEventListener("click", function (event) {
      // -----------------------------
      // Clear-all filters pill
      // -----------------------------
      const clearBtn = event.target.closest("[data-clear-filters]");
      if (clearBtn) {
        event.preventDefault();

        // Reset hidden inputs: clear all, set sort back to default
        Object.keys(hiddenInputs).forEach(function (name) {
          if (name === "sort") {
            hiddenInputs[name].value = DEFAULT_SORT;
          } else {
            hiddenInputs[name].value = "";
          }
        });

        // Clear search input
        const searchInput = form.querySelector('input[name="q"]');
        if (searchInput) {
          searchInput.value = "";
        }

        // Reset visual state of all pills
        const allPills = form.querySelectorAll("[data-filter-name]");
        allPills.forEach(function (btn) {
          const filterName = btn.getAttribute("data-filter-name");
          const filterValue = btn.getAttribute("data-filter-value");
          const isDefaultSort =
            filterName === "sort" && filterValue === DEFAULT_SORT;

          btn.classList.toggle("btn-primary", isDefaultSort);
          btn.classList.toggle("btn-outline", !isDefaultSort);
          btn.setAttribute("aria-pressed", isDefaultSort ? "true" : "false");
        });

        autoSubmit();
        return;
      }

      // -----------------------------
      // Individual filter pills
      // -----------------------------
      const btn = event.target.closest("[data-filter-name]");
      if (!btn) return;

      event.preventDefault();

      const filterName = btn.getAttribute("data-filter-name");
      const filterValue = btn.getAttribute("data-filter-value");
      const hidden = hiddenInputs[filterName];
      if (!hidden) return;

      const currentlyActive = hidden.value === filterValue;

      // Toggle value: clicking an active pill clears it
      if (currentlyActive) {
        setHiddenValue(filterName, "");
      } else {
        setHiddenValue(filterName, filterValue);
      }

      // Update styles for all buttons in this group
      const groupButtons = form.querySelectorAll(
        '[data-filter-name="' + filterName + '"]'
      );
      groupButtons.forEach(function (b) {
        const val = b.getAttribute("data-filter-value");
        const isActive = !currentlyActive && val === filterValue;
        b.classList.toggle("btn-primary", isActive);
        b.classList.toggle("btn-outline", !isActive);
        b.setAttribute("aria-pressed", isActive ? "true" : "false");
      });

      autoSubmit();
    });
  })();
</script>
{% endblock content %}
